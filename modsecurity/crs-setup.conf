###############################################################################
# OWASP Core Rule Set (CRS) Setup Configuration - Production Baseline
#
# This file defines tuning variables consumed by CRS rule phases. A balanced
# approach is applied: Paranoia Level 1 enforced (blocking), Level 2 observed
# (detection only) to gather telemetry before tightening. Adjust after review.
#
# Strategy:
#  - Start with PL1 enforced (low false positives) => blocking_paranoia_level=1
#  - Run PL2 in detect mode => detection_paranoia_level=2 (no blocking yet)
#  - After tuning exclusions for FPs at PL2, raise blocking_paranoia_level.
#  - Keep PL3/PL4 disabled initially unless you have strong FP handling workflow.
#
# Thresholds:
#  - Inbound anomaly threshold 15 (default CRS is 5/10 depending version). 15 reduces
#    casual noise while still catching multi-vector attacks.
#  - Outbound anomaly threshold 10 (tighter to catch possible data exfil patterns)
#  - Global anomaly threshold mirrors inbound unless separately tuned.
#
# Additional hardening variables set below: file upload size, args limits, restricted
# file extensions, and protocol / method constraints for a typical JSON/REST API.
#
# After a stable period (1-2 weeks) review logs where anomaly score 8-14, tune
# whitelisting (rule removal by id/tag for specific endpoints) then consider:
#   blocking_paranoia_level=2, detection_paranoia_level=3.
###############################################################################

# -- Version Marker ----------------------------------------------------------
SecAction "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.crs_setup_version=4.18.0"

# -- Core Paranoia & Thresholds ---------------------------------------------
SecAction "id:900001,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.blocking_paranoia_level=1,\
    setvar:tx.detection_paranoia_level=2,\
    setvar:tx.anomaly_score_threshold=15,\
    setvar:tx.inbound_anomaly_score_threshold=15,\
    setvar:tx.outbound_anomaly_score_threshold=10"

# -- Application Identification ---------------------------------------------
SecAction "id:900002,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.application_name=ModSecPoc"

# -- Allowed HTTP Methods ---------------------------------------------------
# Keep narrow. Add only if required: OPTIONS PUT PATCH DELETE.
SecAction "id:900003,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.allowed_methods=GET POST HEAD OPTIONS'"

# -- Allowed Content-Types --------------------------------------------------
# Trim to what the API actually expects. Add XML or others only if needed.
SecAction "id:900004,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.allowed_request_content_type=application/json|application/x-www-form-urlencoded|multipart/form-data|text/plain'"

# -- Disallowed file extensions / upload restrictions -----------------------
SecAction "id:900005,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.restricted_extensions=.asa/.asax/.ascx/.axd/.backup/.bak/.cfg/.cmd/.com/.conf/.config/.cs/.csproj/.dll/.exe/.htaccess/.htpasswd/.ini/.jar/.jsp/.jspx/.log/.php/.php5/.phtml/.pl/.py/.rar/.sh/.sql/.svn/.swp/.tar/.war/.zip'"

# -- Disallowed file names (sensitive) --------------------------------------
SecAction "id:900006,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.restricted_files=web.config|appsettings.json|composer.json|composer.lock|package.json|yarn.lock|Gemfile|Gemfile.lock|gradle.build|build.gradle|pom.xml'"

# -- File Upload / Request Size Controls ------------------------------------
SecAction "id:900007,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.max_file_size=10485760,\
    setvar:tx.max_num_args=256,\
    setvar:tx.arg_name_length=128,\
    setvar:tx.arg_length=16384,\
    setvar:tx.total_arg_length=65536"

# -- Protocol Policy Tweaks -------------------------------------------------
SecAction "id:900008,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2,\
    setvar:'tx.allowed_request_content_type_charset=utf-8|UTF-8'"

# -- Outbound Leakage Tightening (Optional baseline) ------------------------
SecAction "id:900009,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.outbound_anomaly_score_threshold=10"

###############################################################################
# Tuning Guidance:
# 1. Run in detection mode first (set EnforceMode=false in appsettings) while
#    these thresholds collect telemetry. Review logs for false positives.
# 2. Add targeted exclusions using ctl:ruleRemoveById / ruleRemoveTargetByTag
#    for specific endpoints (do NOT blanket disable categories globally).
# 3. Once stable, either:
#       - Raise blocking_paranoia_level to 2 (if PL2 noise is handled), OR
#       - Lower inbound threshold gradually (15 -> 12 -> 10) for stricter posture.
# 4. For high security contexts, analyze PL3 rule impacts in a staging environment.
# 5. Monitor outbound anomalies; if excessive FPs, raise outbound threshold to 12.
# 6. Adjust restricted extensions/files to match your deployment stack.
###############################################################################