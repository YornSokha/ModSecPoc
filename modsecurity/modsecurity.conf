# ModSecurity Configuration File
# Simple setup for ModSecurity v3.0+ with ASP.NET Core

# -- Rule engine initialization ----------------------------------------------
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On

# -- Request body handling ---------------------------------------------------
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# -- Response body handling --------------------------------------------------
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# -- Filesystem configuration -----------------------------------------------
SecDataDir /tmp/
SecTmpDir /tmp/

# -- File uploads handling configuration -------------------------------------
SecUploadDir /tmp/
SecUploadKeepFiles Off

# -- Debug log configuration -------------------------------------------------
SecDebugLog /tmp/modsec_debug.log
SecDebugLogLevel 3

# -- Audit log configuration -------------------------------------------------
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /tmp/modsec_audit.log

# -- Miscellaneous -----------------------------------------------------------
SecArgumentSeparator &
SecCookieFormat 0

# Enhanced rules for reliable blocking

# Block SQL injection attempts - multiple patterns
SecRule ARGS|ARGS_NAMES "@rx (?i:(union\s+select|insert\s+into|delete\s+from|drop\s+table|or\s+1\s*=\s*1))" \
    "id:1001,\
    phase:2,\
    deny,\
    status:403,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"

# Block XSS attempts - enhanced patterns
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?i:(<script|javascript:|on\w+\s*=|<img|alert\s*\())" \
    "id:1002,\
    phase:2,\
    deny,\
    status:403,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-xss',\
    severity:'CRITICAL'"

# Block directory traversal attempts in URL - Phase 1
SecRule REQUEST_URI "@rx (?i:(\\.\\./|\\.\\.\\\\|\\.\\.|/etc/|/proc/|\\.\\.%2f|%2e%2e/))" \
    "id:1003,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Directory Traversal Attack Detected in URL',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'attack-traversal',\
    severity:'CRITICAL'"

# Block SQL injection in URL parameters - Phase 1  
SecRule REQUEST_URI "@rx (?i:(\'\s*or\s*[\'\d\s=]*|union\s+select|drop\s+table|select.*from|insert.*into|delete.*from))" \
    "id:1006,\
    phase:1,\
    deny,\
    status:403,\
    msg:'SQL Injection Attack Detected in URL',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"

# Block suspicious user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (?i:(sqlmap|nikto|nmap))" \
    "id:1004,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Suspicious User-Agent Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-reconnaissance',\
    severity:'WARNING'"

# Block common SQL injection patterns in request body
SecRule REQUEST_BODY "@rx (?i:(union\s+select|drop\s+table|\'\s*or\s*\'\d*\'\s*=\s*\'\d*))" \
    "id:1005,\
    phase:2,\
    deny,\
    status:403,\
    msg:'SQL Injection in Request Body Detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"