# ModSecurity Configuration File
# Simple setup for ModSecurity v3.0+ with ASP.NET Core

# -- Rule engine initialization ----------------------------------------------
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On

# -- Request body handling ---------------------------------------------------
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# -- Response body handling --------------------------------------------------
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# -- Filesystem configuration -----------------------------------------------
SecDataDir /tmp/
SecTmpDir /tmp/

# -- File uploads handling configuration -------------------------------------
SecUploadDir /tmp/
SecUploadKeepFiles Off

# -- Debug log configuration -------------------------------------------------
SecDebugLog /tmp/modsec_debug.log
SecDebugLogLevel 3

# -- Audit log configuration -------------------------------------------------
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /tmp/modsec_audit.log

# -- Miscellaneous -----------------------------------------------------------
SecArgumentSeparator &
SecCookieFormat 0

# Simple rules to demonstrate functionality

# Block simple SQL injection keywords
SecRule ARGS "@rx (?i:(union.*select|insert.*into|delete.*from|drop.*table))" \
    "id:1001,\
    phase:2,\
    block,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"

# Block simple XSS patterns
SecRule ARGS "@rx (?i:(<script|javascript:|on\w+\s*=))" \
    "id:1002,\
    phase:2,\
    block,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-xss',\
    severity:'CRITICAL'"

# Block directory traversal attempts
SecRule ARGS "@rx \\.\\./|\\.\\.\\\\|\\.\\.\\/\\/|\\.\\.\\\\\\\\)" \
    "id:1003,\
    phase:2,\
    block,\
    msg:'Directory Traversal Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-traversal',\
    severity:'CRITICAL'"

# Block suspicious user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (?i:(sqlmap|nikto|nmap|curl))" \
    "id:1004,\
    phase:2,\
    block,\
    msg:'Suspicious User-Agent Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-reconnaissance',\
    severity:'WARNING'"